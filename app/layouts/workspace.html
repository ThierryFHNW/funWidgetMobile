<link rel="import" href="../elements/app-layout.html">
<link rel="import" href="../elements/awall-menu.html">

<polymer-element name="layout-workspace" extends="app-layout">
    <template>
        <style>
            #container {
                display: flex;
                flex-direction: column;
            }

            header, footer {
                color: white;
                padding: 1em;
                background-color: #000000;
            }

            header {
                display: none;
            }

            footer {
                position: fixed;
                Width: 100%;
                bottom: 0;
                height: 2em;
                z-index: 200;
            }

            #body {
                flex: 1;
                padding: 0.3em;
                display: flex;
                flex-direction: column;
                margin-bottom: 4em;
            }

            #widgets {
                display: flex;
            }

            .widgetDropzone {
                flex: 1 1 10%;
                margin-right: 0.3em;
                margin-bottom: 0.3em;
                height: 13em;
                box-sizing: border-box;
                position: relative;
            }

            @media only screen and (max-height: 40rem) {
                .widgetDropzone {
                    height: 3.5em;
                }
            }

            #widgetmain {
                position: relative;
                height: 100%;
                width: 100%;
            }

            .hidden {
                display: none;
            }

            a {
                color: white;
                padding: 0 1em;
            }
        </style>
        <div id="container">
            <header>HEADER</header>
            <div id="body">
                <div id="widgets">
                    <div class="widgetDropzone hidden" id="widgetDropzone1"></div>
                    <div class="widgetDropzone hidden" id="widgetDropzone2"></div>
                    <div class="widgetDropzone hidden" id="widgetDropzone3"></div>
                    <div class="widgetDropzone hidden" id="widgetDropzone4"></div>
                    <div class="widgetDropzone hidden" id="widgetDropzone5"></div>
                    <div class="widgetDropzone hidden" id="widgetDropzone6"></div>
                    <div class="widgetDropzone hidden" id="widgetDropzone7"></div>
                    <div class="widgetDropzone hidden" id="widgetDropzone8"></div>
                    <div class="widgetDropzone hidden" id="widgetDropzone9"></div>
                    <div class="widgetDropzone hidden" id="widgetDropzone10"></div>
                    <awall-menu id="menu"></awall-menu>
                </div>
                <div id="widgetDropzonemain"></div>
            </div>

            <template if="{{!$.globals.isSmallScreenHeight}}">
                <footer>
                    <template repeat="{{workspace in $.globals.workspaces}}">
                        <a href="{{workspace.parsedPath}}">
                            {{workspace.name}}
                        </a>
                    </template>
                </footer>
            </template>
        </div>
        <app-core id="globals"></app-core>
    </template>
    <script>
        Polymer(Polymer.mixin({
            /**
             * List of added widgets.
             */
            widgets: [],
            /**
             * Sorted list of info-view widget (without main widget).
             * Sorted by position.
             */
            sortedInfoViewWidgets: [],
            /**
             * Map of widget.id -> view (HTML element)
             */
            widgetIdToView: {},
            /**
             * Minimal widget size in pixel.
             */
            minWidgetWidthInPx: 250,
            /**
             * Called when widgetsToDispaly changes.
             * Recalculates which widgets should be shown.
             */
            widgetsToDisplayChanged: function () {
                var totalWidgetWidth = 0;
                this.sortedInfoViewWidgets.forEach(function (widget) {
                    if (totalWidgetWidth < this.widgetsToDisplay) {
                        var widgetHasRoom = (totalWidgetWidth + widget.width) <= this.widgetsToDisplay;
                        if (widgetHasRoom) {
                            this.showWidget(widget);
                            totalWidgetWidth += widget.width;
                        } else {
                            this.hideWidget(widget);
                        }
                    } else {
                        this.hideWidget(widget);
                    }
                }, this);
            },
            domReady: function () {
                this.sortedInfoViewWidgets = this.widgets.filter(function (widget) {
                    return widget.position !== 'main';
                }).sort(function (a, b) {
                    return a.position >= b.position ? 1 : -1;
                });

                var onResize = function () {
                    var availableWidgetWidth = this.$.widgets.clientWidth - this.$.menu.clientWidth;
                    var newWidgetsToDisplay = Math.floor(availableWidgetWidth / this.minWidgetWidthInPx);
                    newWidgetsToDisplay = Math.max(newWidgetsToDisplay, 1);
                    if (newWidgetsToDisplay !== this.widgetsToDisplay) {
                        this.widgetsToDisplay = newWidgetsToDisplay;
                    }
                };

                window.addEventListener('resize', onResize.bind(this));
                // call to set initial arrangement
                onResize.call(this);
            },
            created: function () {
                this.widgets = [];
                this.widgetIdToView = {};
            },
            addWidget: function (widget, widgetNode) {
                this.widgets.push(widget);

                var targetId = 'widgetDropzone' + widget.position;
                var targetView = this.$[targetId];

                if (targetView === null) {
                    console.error('No element with the ID ' + targetId + ' exists, cannot add widget ' + widget.id);
                    return;
                }

                this.widgetIdToView[widget.id] = targetView;

                // adjust the width of the widget
                if (widget.width > 1) {
                    // widget may be max. 50% of width
                    var widgetWidth = widget.width > 5 ? 5 : widget.width;
                    targetView.style.flexBasis = (10 * widgetWidth) + '%';
                }

                // enable dropzone for all widgets except main widget
                if (widget.position !== 'main') {
                    // show the dropzone if a widget is present
                    targetView.classList.remove('hidden');

                    // activate dropzone
                    this.touch.makeDropzone(targetView, {
                        accept: '.widget'
                    });
                }

                this.setView(targetId, widgetNode);

                if (widget.hidden) {
                    this.hideWidget(widget);
                }
            },
            hideWidget: function (widget) {
                var widgetView = this.widgetIdToView[widget.id];
                if (widgetView === undefined) {
                    console.error('Cannot hide widget with id: ' + widget.id + ', not registered.');
                    return;
                }
                widget.hidden = true;
                if (!widgetView.classList.contains('hidden')) {
                    widgetView.classList.add('hidden');
                }
            },
            showWidget: function (widget) {
                var widgetView = this.widgetIdToView[widget.id];
                if (widgetView === undefined) {
                    console.error('Cannot show widget with id: ' + widget.id + ', not registered.');
                    return;
                }
                widget.hidden = false;
                widgetView.classList.remove('hidden');
            },
            isWidgetShown: function (widget) {
                var widgetView = this.widgetIdToView[widget.id];
                if (widgetView === undefined) {
                    console.error('Widget with id: ' + widget.id + ' is not registered.');
                    return;
                }
                return !widgetView.classList.contains('hidden');
            }
        }, window.appMixin));
    </script>
</polymer-element>