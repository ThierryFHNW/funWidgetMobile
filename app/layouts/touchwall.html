<link rel="import" href="../elements/app-layout.html">
<link rel="import" href="../elements/awall-menu.html">

<polymer-element name="workspace-layout-touchwall" extends="app-layout">
    <template>
        <style>
            #container {
                display: flex;
                height: 100vh;
                flex-direction: column;
            }

            header, footer {
                color: white;
                padding: 1em;
                background-color: #000000;
                display: none;
            }

            #body {
                flex: 1;
                padding: 0.3em;
                display: flex;
                flex-direction: column;
                overflow-y: scroll;
            }

            #widgets {
                display: flex;
            }

            .widgetDropzone {
                flex: 1 1 22%;
                margin-right: 0.3em;
                margin-bottom: 0.3em;
                height: 13em;
                box-sizing: border-box;
                position: relative;
            }

            @media only screen and (max-height: 40rem) {
                .widgetDropzone {
                    height: 3.5em;
                }
            }

            #mainWorkspace {
                position: relative;
                height: 100%;
                width: 100%;
            }

            .hidden {
                display: none;
            }
        </style>
        <div id="container">
            <header>HEADER</header>
            <div id="body">
                <div id="widgets">
                    <div class="widgetDropzone hidden" id="widget1"></div>
                    <div class="widgetDropzone hidden" id="widget2"></div>
                    <div class="widgetDropzone hidden" id="widget3"></div>
                    <div class="widgetDropzone hidden" id="widget4"></div>
                    <div class="widgetDropzone hidden" id="widget5"></div>
                    <div class="widgetDropzone hidden" id="widget6"></div>
                    <div class="widgetDropzone hidden" id="widget7"></div>
                    <awall-menu></awall-menu>
                </div>
                <div id="mainWorkspace"></div>
            </div>

            <footer>FOOTER</footer>
        </div>
    </template>
    <script>
        (function () {

            function switchWidgets(shadowRootA, shadowRootB) {
                var rootAContent = [];
                [].forEach.call(shadowRootA.children, function (e) {
                    rootAContent.push(e);
                });

                var rootBContent = [];
                [].forEach.call(shadowRootB.children, function (e) {
                    rootBContent.push(e);
                });

                [].forEach.call(rootBContent, function (e) {
                    shadowRootA.appendChild(e);
                });

                [].forEach.call(rootAContent, function (e) {
                    shadowRootB.appendChild(e);
                });
            }

            function enableDropzone(dropzoneElement) {
                require(['core-touch'], function (touch) {
                    touch.makeDropZone(dropzoneElement, '.widget');
//                    touch.on(dropzoneElement, 'drop', function (event) {
//                        switchWidgets(event.relatedTarget.shadowRoot, event.target.children[0].shadowRoot);
//                        // reposition draggables
//                        touch.resetPosition(event.relatedTarget);
//                        touch.resetPosition(event.target.children[0]);
//                    });
                });
            }

            Polymer({
                widgetIdToView: {},
                addWidget: function (targetId, content, widget) {
                    function contains(source, searchTerm) {
                        for (var i in searchTerm) {
                            if (source[i] !== searchTerm[i]) {
                                return false;
                            }
                        }
                        return true;
                    }

                    function isWidget(id) {
                        return !contains(id, 'mainWorkspace');
                    }

                    if (isWidget(targetId)) {
                        targetId = 'widget' + targetId;

                        var targetDropzone = this.$[targetId];
                        if (targetDropzone === null) {
                            console.error('Parent dropzone for ' + targetId + ' not found');
                            return;
                        }
                        // show the dropzone if a widget is present
                        targetDropzone.classList.remove('hidden');

                        // activate dropzones
                        enableDropzone(targetDropzone);
                    }

                    this.widgetIdToView[widget.id] = this.$[targetId];

                    this.super([targetId, content]);
                },
                hideWidget: function (widgetId) {
                    var widget = this.widgetIdToView[widgetId];
                    if (widget === undefined) {
                        console.error('Cannot hide widget with id: ' + widgetId + ', not registered.');
                        return;
                    }
                    widget.classList.add('hidden');
                },
                showWidget: function (widgetId) {
                    var widget = this.widgetIdToView[widgetId];
                    if (widget === undefined) {
                        console.error('Cannot show widget with id: ' + widgetId + ', not registered.');
                        return;
                    }
                    widget.classList.remove('hidden');
                },
                isWidgetShown: function (widgetId) {
                    var widget = this.widgetIdToView[widgetId];
                    if (widget === undefined) {
                        console.error('Widget with id: ' + widgetId + ' is not registered.');
                        return;
                    }
                    return !widget.classList.contains('hidden');
                },
                ready: function () {
                    console.log('workspace-layout touchwall is ready.');
                }
            });
        })();
    </script>
</polymer-element>