<polymer-element name="workspace-layout-touchwall" extends="app-layout">
    <template>
        <app-globals id="globals"></app-globals>
        <style>
            #container {
                display: flex;
                height: 100vh;
                flex-direction: column;
            }

            #header, #footer {
                color: white;
                padding: 1em;
                background-color: #000000;
            }

            #body {
                flex: 1;
                margin: 5px;
                display: flex;
                flex-direction: column;
                overflow-y: scroll;
            }

            #widgets {
                display: flex;
            }

            .widgetDropzone {
                flex: 0 0 25%;
                margin-right: 5px;
                margin-bottom: 5px;
                width: 350px;
                height: 200px;
                box-sizing: border-box;
            }

            .widget {
                position: relative;
                height: 100%;
                width: 100%;
            }

            #mainWorkspace-dropzone {
                flex: 1;
                width: 100%;
                height: 100%;
            }

            .dragging {
                width: 250px;
                height: 150px;
            }

            .hidden {
                display: none;
            }

            .drop-active {
                background-color: #ffff00;
            }

            .drop-entered {
                background-color: green;
            }
        </style>
        <div id="container">
            <div id="header">HEADER</div>
            <div id="body">
                <div id="widgets">
                    <div class="widgetDropzone hidden" id="widget1-dropzone">
                        <div class="widget" id="widget1"></div>
                    </div>
                    <div class="widgetDropzone hidden" id="widget2-dropzone">
                        <div class="widget" id="widget2"></div>
                    </div>
                    <div class="widgetDropzone hidden" id="widget3-dropzone">
                        <div class="widget" id="widget3"></div>
                    </div>
                    <div class="widgetDropzone hidden" id="widget4-dropzone">
                        <div class="widget" id="widget4"></div>
                    </div>
                </div>

                <div id="mainWorkspace-dropzone">
                    <div class="widget" id="mainWorkspace"></div>
                </div>
            </div>

            <div id="footer">FOOTER</div>
        </div>
    </template>
    <script>
        (function () {

            function switchWidgets(shadowRootA, shadowRootB) {
                var rootAContent = [];
                [].forEach.call(shadowRootA.children, function (e) {
                    rootAContent.push(e);
                });

                var rootBContent = [];
                [].forEach.call(shadowRootB.children, function (e) {
                    rootBContent.push(e);
                });

                [].forEach.call(rootBContent, function (e) {
                    shadowRootA.appendChild(e);
                });

                [].forEach.call(rootAContent, function (e) {
                    shadowRootB.appendChild(e);
                });
            }

            function enableDropzone(dropzoneElement) {
                require(['core-dnd'], function (dnd) {
                    dnd.makeDropZone(dropzoneElement, '.widget');
                    dnd.addInteractEventListener(dropzoneElement, 'drop', function (event) {
                        console.dir(event);
                        switchWidgets(event.relatedTarget.shadowRoot, event.target.children[0].shadowRoot);
                        // reposition draggables
                        dnd.resetPosition(event.relatedTarget);
                        dnd.resetPosition(event.target.children[0]);
                    });
                });
            }

            function enableDraggable(target) {
                require(['core-dnd'], function (dnd) {
                    dnd.makeDraggable(target);
                });
            }


            Polymer({
                addWidget: function (targetId, content) {
                    function contains(source, searchTerm) {
                        for (var i in searchTerm) {
                            if (source[i] !== searchTerm[i]) {
                                return false;
                            }
                        }
                        return true;
                    }

                    function isWidget(id) {
                        return contains(id, 'widget');
                    }

                    function isMainWorkspace(id) {
                        return contains(id, 'mainWorkspace')
                    }

                    if (isWidget(targetId)) {
                        console.log('is widget or mainWorkspace: ' + targetId);

                        var targetDropzone = this.$[targetId + '-dropzone'];
                        if (targetDropzone == null) {
                            console.error('Parent dropzone for ' + targetId + ' not found');
                            return;
                        }
                        // show the dropzone if a widget is present
                        targetDropzone.classList.remove('hidden');

                        if (targetDropzone.children.length != 1) {
                            console.error('The dropzone ofclass="widget" ' + targetId + ' must only contain a single div for the widget itself.');
                            return;
                        }
                        var target = targetDropzone.children[0];

                        // activate draggable and dropzones
                        enableDraggable(target);
                        enableDropzone(targetDropzone);
                    }

                    this.super([targetId, content]);
                },
                ready: function () {
                    console.log('workspace-layout touchwall is ready.');
                }
            });
        })();
    </script>
</polymer-element>