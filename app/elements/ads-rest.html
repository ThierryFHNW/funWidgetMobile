<polymer-element name="ads-rest-collection" hidden attributes="resource response params auto">
    <template>
        <core-ajax id="ajax" url="http://windows92.cs.technik.fhnw.ch/api/{{resource}}" handleAs="json"
                   auto="{{auto != undefined}}" params="{{params}}" on-core-response="{{onLoaded}}"></core-ajax>
    </template>
    <script>
        (function () {
            // these variables are shared by all instances
//            var wsEventsUrl = 'ws://windows92.cs.technik.fhnw.ch/api/wsevents';
            var wsEventsUrl = 'ws://localhost:8001';

            var wsEvents = new WebSocket(wsEventsUrl);

            console.log("GLOBAL CODE");

            wsEvents.onopen = function () {
                console.log('connected');
            };
            wsEvents.onmessage = function (evt) {
                console.log(evt.data);
                observers.forEach(function (observer) {
                    observer(evt.data);
                });
            };
            wsEvents.onerror = function (evt) {
                console.log(evt.message);
            };
            wsEvents.onclose = function () {
                console.log('disconnected');
            };

            function send(message) {
                if (wsEvents.readyState == WebSocket.OPEN) {
                    wsEvents.send(message);
                } else {
                    console.log('Connection is closed');
                }
            }

            var observers = [];

            function registerObserver(observer) {
                if (!(observer in observers)) {
                    observers.push(observer);
                }
            }

            Polymer({
                onLoaded: function () {
                    if ('onDataChanged' in this) {
                        registerObserver(this.onDataChanged);
                    }
                    this.response = this.$.ajax.response.items;
                },
                go: function () {
                    this.$.ajax.go();
                },
                /**
                 *  Sets the parameters for the query.
                 * @param params Map of parameter name and value
                 */
                setParams: function (params) {
                    this.params = JSON.stringify(params);
                    console.log(this.params);
                }
            });
        })();
    </script>
</polymer-element>

<polymer-element name="ads-rest-people" extends="ads-rest-collection" attributes="response auto projectId">
    <script>
        Polymer({
            onDataChanged: function (msg) {
                console.log('received message in ads-rest-people: ' + msg);
            },
            go: function () {
                this.setParams({project: this.projectId});
                this.super();
            },
            resource: "people"
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-sprints" extends="ads-rest-collection" attributes="response auto">
    <script>
        Polymer({
            resource: "sprints"
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-userstories" extends="ads-rest-collection" attributes="response auto">
    <script>
        Polymer({
            resource: "userstories"
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-tasks" extends="ads-rest-collection" attributes="response auto">
    <script>
        Polymer({
            resource: "tasks"
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-single" hidden attributes="resource resourceId response expand auto">
    <template>
        <core-ajax id="ajax" url="http://windows92.cs.technik.fhnw.ch/api/{{resource}}/{{resourceId}}" handleAs="json"
                   params='{ "expand": "{{expand}}" }' auto="{{auto != undefined}}"
                   on-core-response="{{onLoaded}}"></core-ajax>
    </template>
    <script>
        Polymer({
            onLoaded: function () {
                this.response = this.$.ajax.response;
            },
            go: function () {
                this.$.ajax.go();
            },
            save: function (resource) {
                var ajax = this.$.ajax;
                ajax.method = resource.hasOwnProperty('id') ? 'PUT' : 'POST';
                ajax.body = JSON.stringify(resource);
                ajax.go();
            },
            remove: function (resource) {
                var ajax = this.$.ajax;
                ajax.method = 'DELETE';
                ajax.go();
            }
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-project" extends="ads-rest-single" attributes="resourceId response expand auto">
    <script>
        Polymer({
            resource: "projects"
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-sprint" extends="ads-rest-single" attributes="resourceId response expand auto">
    <script>
        Polymer({
            resource: "sprints"
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-person" extends="ads-rest-single" attributes="resourceId response expand auto">
    <script>
        Polymer({
            resource: "people"
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-userstory" extends="ads-rest-single" attributes="resourceId response expand auto">
    <script>
        Polymer({
            resource: "userstories"
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-task" extends="ads-rest-single" attributes="resourceId response expand auto">
    <script>
        Polymer({
            resource: "tasks"
        });
    </script>
</polymer-element>