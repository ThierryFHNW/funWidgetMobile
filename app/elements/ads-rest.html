<polymer-element name="ads-rest-base" hidden>
    <script>
        (function () {
            // these variables are shared by all instances
            var awallUrl = 'ws://windows92.cs.technik.fhnw.ch/api/awall';
            var awallEndpoint = new WebSocket(awallUrl);


            awallEndpoint.onopen = function () {
                console.log('connected');
            };
            awallEndpoint.onmessage = function (evt) {
                console.log(evt.data);
                var data = JSON.parse(evt.data);
                var type = data.resourceType;
                if (!observers.hasOwnProperty(type)) {
                    console.log('No observers are listening for changes of type ' + type);
                    return;
                }
                observers[type].forEach(function (observer) {
                    observer(data);
                });
            };
            awallEndpoint.onerror = function (evt) {
                console.log(evt.message);
            };
            awallEndpoint.onclose = function () {
                console.log('disconnected');
            };

//            function send(message) {
//                if (awallEndpoint.readyState == WebSocket.OPEN) {
//                    awallEndpoint.send(message);
//                } else {
//                    console.log('Connection is closed');
//                }
//            }

            var observers = {};

            function registerObserver(resource, observer) {
                if (!observers.hasOwnProperty(resource)) {
                    observers[resource] = [];
                    observers[resource].push(observer);
                } else if (!(observer in observers[resource])) {
                    observers[resource].push(observer);
                }
            }

            Polymer({
                ready: function () {
                    if ('onDataChanged' in this) {
                        registerObserver(this.notificationType, this.onDataChanged.bind(this));
                    }
                    if (this.auto !== undefined) {
                        this.go();
                    }
                },
                /**
                 *  Sets the parameters for the query.
                 * @param params Map of parameter name and value
                 */
                setParams: function (params) {
                    if (params == undefined) {
                        params = Object.create(null);
                    }
                    if (this.expand != undefined) {
                        params.expand = this.expand;
                    }
                    this.params = JSON.stringify(params);
                },
                /**
                 * Callback called when something happened on the server and we are notified.
                 * @param data
                 */
                onDataChanged: function (data) {
                    function update() {
                        if (this.response.constructor == Array) {
                            console.log('Update collection');
                            for (var i = 0; i < this.response.length; i++) {
                                var obj = this.response[i];
                                if (data.data.id === obj.id) {
                                    this.response[i] = data.data;
                                }
                            }
                        } else {
                            console.log('Update single');
                            if (this.response.id === data.data.id) {
                                this.response = data.data;
                            }
                        }
                    }

                    console.log('new message: ' + data.resourceType + ': ' + data.action);
                    console.dir(data.data);
                    if (this.response === null || this.response === undefined) {
                        console.error('Cannot update the model(s), the response was null or undefined!');
                        return;
                    }
                    if ("Updated" == data.action) {
                        console.log('Update');
                        if (data.data === null) {
                            console.error('data-property was null but should not be.');
                            return;
                        }
                        update.call(this);
                    }
                }
            });
        })();
    </script>
</polymer-element>

<polymer-element name="ads-rest-collection" extends="ads-rest-base" hidden attributes="resource expand response auto">
    <template>
        <core-ajax id="ajax" url="http://windows92.cs.technik.fhnw.ch/api/{{resource}}" handleAs="json"
                   params="{{params}}" on-core-response="{{onLoaded}}"></core-ajax>
    </template>
    <script>
        (function () {
            Polymer({
                onLoaded: function () {
                    this.response = this.$.ajax.response.items;
                },
                go: function () {
                    this.$.ajax.go();
                },
                /**
                 * Creates a resource on the server with an POST request.
                 * @param resource The resource to create.
                 */
                create: function (resource) {
                    if (resource.id !== undefined) {
                        console.error("Can't create a resource that already has an ID.");
                        return;
                    }
                    var ajax = this.$.ajax;
                    ajax.method = 'POST';
                    ajax.contentType = 'application/json;charset=UTF-8';
                    ajax.body = JSON.stringify(resource);
                    ajax.go();
                }
            });
        })();
    </script>
</polymer-element>

<polymer-element name="ads-rest-people" extends="ads-rest-collection" attributes="response auto expand projectId">
    <script>
        Polymer({
            go: function () {
                this.setParams({project: this.projectId});
                this.super();
            },
            resource: 'people',
            notificationType: 'Person'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-sprints" extends="ads-rest-collection" attributes="response auto expand projectId">
    <script>
        Polymer({
            go: function () {
                this.setParams({project: this.projectId});
                this.super();
            },
            resource: 'sprints',
            notificationType: 'Sprint'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-userstories" extends="ads-rest-collection"
                 attributes="response auto expand authorId ownerId sprintId stateId">
    <script>
        Polymer({
            go: function () {
                this.setParams({
                    author: this.authorId,
                    owner: this.ownerId,
                    sprint: this.sprintId,
                    state: this.stateId
                });
                this.super();
            },
            resource: 'userstories',
            notificationType: 'UserStory'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-tasks" extends="ads-rest-collection"
                 attributes="response auto expand authorId assigneeId userStoryId stateId">
    <script>
        Polymer({
            go: function () {
                this.setParams({
                    author: this.authorId,
                    assignee: this.assigneeId,
                    userStory: this.userStoryId,
                    state: this.stateId
                });
                this.super();
            },
            resource: 'tasks',
            notificationType: 'Task'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-taskstates" extends="ads-rest-collection" attributes="response auto projectId taskId">
    <script>
        Polymer({
            go: function () {
                this.setParams({
                    project: this.projectId,
                    task: this.taskId
                });
                this.super();
            },
            resource: 'taskStates',
            notificationType: 'TaskState'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-userstorystates" extends="ads-rest-collection"
                 attributes="response auto projectId userStoryId">
    <script>
        Polymer({
            go: function () {
                this.setParams({
                    project: this.projectId,
                    userStory: this.userStoryId
                });
                this.super();
            },
            resource: 'userStoryStates',
            notificationType: 'UserStoryState'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-single" extends="ads-rest-base" hidden
                 attributes="resource resourceId response expand auto">
    <template>
        <core-ajax id="ajax" url="http://windows92.cs.technik.fhnw.ch/api/{{resource}}/{{resourceId}}" handleAs="json"
                   params="{{params}}" on-core-response="{{onLoaded}}"></core-ajax>
    </template>
    <script>
        Polymer({
            onLoaded: function () {
                this.response = this.$.ajax.response;
            },
            go: function () {
                this.setParams();
                this.$.ajax.go();
            },
            /**
             *  Saves a resource with a PUT request
             *  @param resource The resource to update.
             */
            save: function (resource) {
                if (resource.id === undefined) {
                    console.error("Can't update a resource without an ID!");
                    return;
                }

                // set ID because it may not be set yet if called by JS
                this.resourceId = resource.id;

                /*
                 * Set all arrays to null, because 1:n relationships cannot be updated this way
                 * and the request will fail.
                 */
                for (var attribute in resource) {
                    if (resource[attribute] instanceof Array) {
                        resource[attribute] = null;
                    }
                }

                var ajax = this.$.ajax;
                ajax.method = 'PUT';
                ajax.contentType = 'application/json;charset=UTF-8';
                ajax.body = JSON.stringify(resource);
                ajax.go();
            },
            /**
             * Delete a resource on the server.
             * @param resource The resource to delete.
             */
            remove: function (resource) {
                if (resource.id === undefined) {
                    console.error("Can't delete a resource without an ID!");
                    return;
                }
                // set ID because it may not be set yet if called by JS
                this.resourceId = resource.id;

                var ajax = this.$.ajax;
                ajax.method = 'DELETE';
                ajax.go();
            }
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-project" extends="ads-rest-single" attributes="resourceId response expand auto">
    <script>
        Polymer({
            resource: 'projects',
            notificationType: 'Project'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-sprint" extends="ads-rest-single" attributes="resourceId response expand auto">
    <script>
        Polymer({
            resource: 'sprints',
            notificationType: 'Sprint'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-person" extends="ads-rest-single" attributes="resourceId response expand auto">
    <script>
        Polymer({
            resource: 'people',
            notificationType: 'Person'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-userstory" extends="ads-rest-single" attributes="resourceId response expand auto">
    <script>
        Polymer({
            resource: 'userstories',
            notificationType: 'UserStory'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-task" extends="ads-rest-single" attributes="resourceId response expand auto">
    <script>
        Polymer({
            resource: 'tasks',
            notificationType: 'Task'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-taskstate" extends="ads-rest-single" attributes="resourceId response auto">
    <script>
        Polymer({
            resource: 'taskStates',
            notificationType: 'TaskState'
        });
    </script>
</polymer-element>

<polymer-element name="ads-rest-userstorystate" extends="ads-rest-single" attributes="resourceId response auto">
    <script>
        Polymer({
            resource: 'userStoryStates',
            notificationType: 'UserStoryState'
        });
    </script>
</polymer-element>