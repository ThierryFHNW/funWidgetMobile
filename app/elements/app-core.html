<polymer-element name="app-core" hidden>
    <script>
        (function () {

            // Object with the path-variable (e.g. projectId) as key and the actual value as value.
            var routeParams = {};
            // indicates whether all the workspaces have been loaded.
            var workspacesLoaded = false;

            var workspaces = [];

            var activeWorkspace = null;

            /**
             * Callback function.
             * To be called when the fragment identifier (hashchange) has been changed.
             */
            function routeChanged() {
                for (var i in workspaces) {
                    var workspace = workspaces[i];
                    var newParams = workspace.getPathParameters();
                    if (newParams !== null) {
                        console.log('Found a route for ' + location.hash);
                        routeParams = newParams;
                        activeWorkspace = workspace;
                        activeWorkspace.show();
                        break;
                    }
                }
            }

            window.addEventListener('hashchange', routeChanged);


            function loadWorkspaces() {
                require(['config', 'core-loader'], function (config, loader) {
                    // Map k: url path, v: workspace
                    var urlPathToWorkspace = {};
                    var numberOfWorkspacesLoaded = 0;

                    config.workspaces.forEach(function (workspaceId) {
                        loader.loadWorkspace(workspaceId, function (workspace) {
                            workspaces.push(workspace);
                            urlPathToWorkspace[workspace.path] = workspace;
                            onWorkspacesLoaded();
                        });
                    });

                    function onWorkspacesLoaded() {
                        numberOfWorkspacesLoaded += 1;
                        // all workspaces loaded?
                        if (config.workspaces.length == numberOfWorkspacesLoaded) {
                            workspacesLoaded = true;
                            // load the workspace according to URL
                            routeChanged();
                        }
                    }
                });
            }

            Polymer({
                ready: function () {
                    if (!workspacesLoaded) {
                        loadWorkspaces();
                    }
                },
                get routeParams() {
                    return routeParams;
                },
                get workspaces() {
                    return workspaces.filter(function (space) {
                        // Real workspaces have at least one widget, otherwise it's a single-page widget
                        return Object.keys(space.config.widgets).length > 1;
                    });
                },
                get activeWorkspace() {
                    return activeWorkspace;
                }
            });
        })();
    </script>
</polymer-element>