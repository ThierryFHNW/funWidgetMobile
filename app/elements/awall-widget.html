<polymer-element name="awall-widget">
    <template>
        <style>
            #widget {
                height: 100%;
                background-color: #f2f2f2;
                border: 2px solid #000000;
                box-sizing: border-box;
                overflow: auto;
                position: relative;
            }

            ::content h2 {
                padding: 0.4em;
                margin: 0.4em;
                font-size: 1.2em;
                font-weight: bold;
            }

            .body {
                padding: 0.4em;
                overflow: auto;
            }

            .iconbar {
                float: right;
                margin: 0.15em;
                height: 1.6em;
            }

            .resize {
                cursor: se-resize;
                position: absolute;
                bottom: 0;
                right: 0;
                height: 1em;
                width: 1em;
            }

            @media only screen and (max-height: 40rem) {
                #extendedContent {
                    display: none;
                }
            }
        </style>

        <div id="widget" class="widget">
            <div class="iconbar">
                <core-icon-button icon="create" hidden?="{{hideEditMode}}"
                                  on-tap="{{showEditMode}}"></core-icon-button>
                <core-icon-button icon="aspect-ratio" hidden?="{{hideResizeToInitial}}"
                                  on-tap="{{resizeToInitial}}"></core-icon-button>
                <core-icon-button icon="dashboard" hidden?="{{hideRevertToDock}}"
                                  on-tap="{{revertToDock}}"></core-icon-button>
                <core-icon-button icon="close" hidden?="{{hideCloseEditMode}}"
                                  on-tap="{{closeEditMode}}"></core-icon-button>
            </div>

            <content select="awall-widget-title"></content>

            <div id="extendedContent">
                <content select="awall-widget-size-default"></content>
                <content select="awall-widget-size-full"></content>
                <content select="awall-widget-editable"></content>
            </div>

            <!-- fallback for widgets not using the above sizes with behaviour -->
            <content select="*"></content>
            <div class="resize"></div>
        </div>
    </template>
    <script>
        Polymer({
            publish: {
                /**
                 * Switch to disable draggability of the element.
                 *
                 * @attribute disableDraggable
                 * @type boolean
                 * @default false
                 */
                disableDraggable: false,
                /**
                 * Switch to disable resizability of the element.
                 *
                 * @attribute disableResizable
                 * @type boolean
                 * @default false
                 */
                disableResizable: false
            },
            hideResizeToInitial: true,
            hideRevertToDock: true,
            hideEditMode: true,
            hideCloseEditMode: true,
            widgetSize: {
                height: 0,
                width: 0
            },
            widgetDefault: undefined,
            widgetFull: undefined,
            widgetEditable: undefined,
            widgetSizeElements: [],
            draggableIsFloating: false,
            extendedContentInitallyHidden: false,
            domReady: function () {
                var getSingleElement = function (selector) {
                    var found = this.querySelectorAll(selector);
                    if (found.length > 1) {
                        console.error('Found more than one of: ' + selector + '. Only one is allowed');
                        return null;
                    }
                    return found.length == 1 ? found[0] : null;
                }.bind(this);

                this.widgetDefault = getSingleElement('awall-widget-size-default');
                this.widgetFull = getSingleElement('awall-widget-size-full');
                this.widgetEditable = getSingleElement('awall-widget-editable');

                this.widgetSizeElements = [this.widgetDefault, this.widgetFull, this.widgetEditable].filter(function (widget) {
                    return widget !== undefined && widget !== null;
                });

                // attach onHide/onShow callbacks to full widget
                if (this.widgetFull) {
                    this.widgetFull.onShow = function () {
                        if (this.widgetDefault) {
                            this.widgetDefault.hide();
                        }
                        if (this.widgetEditable) {
                            this.hideEditMode = false;
                        }
                    }.bind(this);
                    this.widgetFull.onHide = function () {
                        if (this.widgetDefault) {
                            this.widgetDefault.show();
                        }
                        if (this.widgetEditable) {
                            this.hideEditMode = true;
                        }
                    }.bind(this);
                }


                // enable touch interaction
                var elementThis = this;
                require(['core-touch'], function (touch) {
                    var widget = elementThis.$.widget;

                    // set the initial size of the widget
                    var size = touch.getElementSize(widget);
                    elementThis.height = size.height;
                    elementThis.width = size.width;

                    // make draggable
                    if (!elementThis.disableDraggable) {
                        touch.makeDraggable(widget, {
                            revert: false,
                            onstart: function () {
                                if (!elementThis.draggableIsFloating) {
                                    elementThis.extendedContentInitallyHidden = elementThis.isExtendedContentHidden();
                                    console.log('dragged out of the info-view, initially hidden: ' + elementThis.extendedContentInitallyHidden);
                                    elementThis.showExtendedContent();
                                }
                                elementThis.draggableIsFloating = true;
                                elementThis.hideRevertToDock = false;
                            },
                            onend: function (event) {
                                elementThis.hideRevertToDock = event.interaction.dropped;
                            },
                            ondrop: function (event) {
                                elementThis.draggableIsFloating = false;
                                if (elementThis.extendedContentInitallyHidden) {
                                    elementThis.hideExtendedContent();
                                }
                                elementThis.resizeToInitial();
                            }
                        });
                    }

                    // make resizable
                    if (!elementThis.disableResizable) {
                        touch.makeResizable(widget, {
                            onstart: function () {
                                elementThis.hideResizeToInitial = false;
                            },
                            onmove: function () {
                                if (!this.disableMove()) {
                                    elementThis.widgetSize = touch.getElementSize(widget);
                                }
                            },
                            disableMove: function () {
                                return elementThis.hideRevertToDock;
                            },
                            onend: function () {
                                elementThis.hideResizeToInitial = touch.isInitialSize(widget);
                            }
                        });
                    }
                });
            },
            hideExtendedContent: function () {
                this.$.extendedContent.style.display = 'none';
            },
            showExtendedContent: function () {
                this.$.extendedContent.style.display = 'inherit';
            },
            isExtendedContentHidden: function () {
                return getComputedStyle(this.$.extendedContent, "").display == 'none';
            },
            resizeToInitial: function () {
                var widget = this.$.widget;
                var elementThis = this;
                require(['core-touch'], function (touch) {
                    // resize to initial and adjust the height/width
                    touch.resizeToInitial(widget);
                    elementThis.widgetSize = touch.getElementSize(widget);
                });
                this.hideResizeToInitial = true;
            },
            revertToDock: function () {
                this.draggableIsFloating = false;
                if (this.extendedContentInitallyHidden) {
                    this.hideExtendedContent();
                }
                this.hideRevertToDock = true;

                var widget = this.$.widget;
                var elementThis = this;
                require(['core-touch'], function (touch) {
                    // resize to initial
                    elementThis.resizeToInitial();

                    touch.resetPosition(widget);
                });
            },
            widgetSizeChanged: function () {
                this.widgetSizeElements.forEach(function (widget) {
                    widget.setDimensions(this.widgetSize.height, this.widgetSize.width);
                }, this);
            },
            showEditMode: function () {
                this.hideEditMode = true;
                this.hideCloseEditMode = false;
                this.hideResizeToInitial = true;
                this.hideRevertToDock = true;
                this.widgetEditable.show();
                this.widgetFull.hide();
                this.widgetDefault.hide();
            },
            closeEditMode: function () {
                this.hideEditMode = false;
                this.hideCloseEditMode = true;
                this.hideResizeToInitial = false;
                this.hideRevertToDock = false;
                this.widgetEditable.hide();
                this.widgetFull.show();
                this.widgetDefault.hide();
            }
        });
    </script>
</polymer-element>


<polymer-element name="awall-widget-size">
    <template>
        <content id="content"></content>
    </template>
    <script>
        Polymer({
            publish: {
                showHeight: -1,
                showWidth: -1,
                onShow: function () {

                },
                onHide: function () {

                }
            },
            height: 0,
            width: 0,
            isManualControl: false,
            attached: function () {
                this.evaluateVisibility();
            },
            evaluateVisibility: function () {
                if (!this.isManualControl) {
                    if (this.height >= this.showHeight && this.width >= this.showWidth) {
                        this.show();
                    } else {
                        this.hide();
                    }
                }
            },
            show: function () {
                this.hidden = false;
                this.onShow();
            },
            hide: function () {
                this.hidden = true;
                this.onHide();
            },
            setDimensions: function (height, width) {
                this.height = height;
                this.width = width;
                this.evaluateVisibility();
            }
        });
    </script>
</polymer-element>

<polymer-element name="awall-widget-size-default" extends="awall-widget-size" noscript></polymer-element>

<polymer-element name="awall-widget-size-full" extends="awall-widget-size">
    <script>
        Polymer({
            publish: {
                showHeight: 400,
                showWidth: 400
            }
        });
    </script>
</polymer-element>

<polymer-element name="awall-widget-editable" extends="awall-widget-size-full">
    <script>
        Polymer({
            isManualControl: true,
            attached: function () {
                this.hide();
            }
        });
    </script>
</polymer-element>

<polymer-element name="awall-widget-title" noscript attributes="icon title">
    <template>
        <style>
            h2 {
                padding: 0.4em;
                margin: 0.4em;
                font-size: 1.2em;
                font-weight: bold;
            }
        </style>
        <h2>{{title}}</h2>
    </template>
</polymer-element>