<polymer-element name="app-router">
    <template>
        <app-globals id="globals"></app-globals>
    </template>
    <script>
        function Route(urlPath, workspace) {
            console.log('+++ Adding route: ' + urlPath);
            this.workspace = workspace;
            this.matcher = routeMatcher(urlPath);
        }

        Route.prototype.parse = function (hashLocation) {
            if (hashLocation.indexOf('#') === 0) {
                hashLocation = hashLocation.substring(1);
            }
            return this.matcher.parse(hashLocation);
        };

        Polymer({
            /**
             * Set the routes for the application.
             * @param urlPathToWorkspaceConfig A map of URL-paths to WorkspaceConfigs
             */
            setRoutes: function (urlPathToWorkspaceConfig) {
                for (var urlPath in urlPathToWorkspaceConfig) {
                    var route = new Route(urlPath, urlPathToWorkspaceConfig[urlPath]);
                    this.routes.push(route);
                }
            },
            /**
             * Callback function.
             * To be called when the fragment identifier (hashchange) has been changed.
             */
            routeChanged: function () {
                for (var i = 0; i < this.routes.length; i++) {
                    var route = this.routes[i];
                    this.routeParams = route.parse(location.hash);
                    if (this.routeParams !== null) {
                        console.log('found a route for ' + location.hash);
                        this.$.globals.setRouteParams(this.routeParams);
                        route.workspace.show();
                        break;
                    }
                }
            },
            ready: function () {
                this.routes = [];
                window.addEventListener('hashchange', function () {
                    this.routeChanged();
                }.bind(this));
            }
        });
    </script>
</polymer-element>