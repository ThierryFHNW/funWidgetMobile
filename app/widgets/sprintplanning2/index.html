<template class="content">
    <ads-sp2></ads-sp2>
</template>

<polymer-element name="ads-sp2">
    <template>
        <style>
            .container {
                display: flex;
                flex-direction: row;
                box-sizing: border-box;
            }

            .productBacklog {
                flex: 0 0 250px;
            }

            .sprintBacklog {
                flex: 1;
            }

            .tempTasks {
                flex: 0 0 35%;
            }

            h3 {
                padding-left: 10px;
            }

            table {
                border-collapse: collapse;
                box-sizing: border-box;
                margin-bottom: 10px;
                width: 100%;
            }

            tr:nth-child(even) {
                background-color: rgba(255, 255, 255, 0.5);
            }

            th {
                border-bottom: 2px solid rgb(221, 221, 221);
                border-collapse: collapse;
                text-align: left;
            }

            td {
                border-top: 1px solid rgb(221, 221, 221);
                vertical-align: top;
            }

            td:nth-child(1) {
                padding: 8px;
                text-align: left;
                width: 10%; /* will be dynamically as big as the content */
            }
        </style>
        <ads-widget>
            <h2>Sprintplanning 2</h2>

            <div class="container">
                <div class="productBacklog">
                    <h3>Product Backlog</h3>
                    <template repeat="{{story in userstories | noPriority}}">
                        <ads-userstorycard userstory="{{story}}"></ads-userstorycard>
                    </template>
                    <core-icon-button icon="add" on-tap="{{onAddUserStorytap}}">Add User Story</core-icon-button>
                    <ads-form-userstory id="usForm"></ads-form-userstory>
                </div>
                <div class="sprintBacklog">
                    <h3>Sprint Backlog</h3>
                    <table class="table">
                        <tbody>
                        <template repeat="{{story in userstories | withPriority | orderBy('priority')}}">
                            <tr>
                                <td>
                                    <ads-userstorycard userstory="{{story}}" disableDraggable></ads-userstorycard>
                                </td>
                                <td>
                                    <awall-sp2-temptask-dropzone userstory="{{story}}">
                                        <awall-sp2-ustasks userstoryId="{{story.id}}"></awall-sp2-ustasks>
                                    </awall-sp2-temptask-dropzone>
                                </td>
                            </tr>
                        </template>
                        <tr>
                            <td colspan="2">
                                <awall-sp2-us-dropzone></awall-sp2-us-dropzone>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="tempTasks">
                    <h3>Tasks</h3>
                    <template repeat="{{task in tempTasks}}">
                        <ads-temp-taskcard task="{{task}}"></ads-temp-taskcard>
                    </template>
                    <ads-form-temp-task id="taskForm"></ads-form-temp-task>

                    <core-icon-button icon="add" on-tap="{{onAddTempTaskTap}}">Add Temp Task</core-icon-button>
                </div>
            </div>
        </ads-widget>
        <app-globals id="globals"></app-globals>
        <ads-rest-awall-sp2 tasks="{{tempTasks}}"></ads-rest-awall-sp2>
        <ads-rest-userstories id="usEndpoint" sprintId="{{sprintId}}"
                              response="{{userstories}}"></ads-rest-userstories>
    </template>
    <script>
        Polymer({
            ready: function () {
                this.sprintId = this.$.globals.routeParams.sprintId;
                this.$.usEndpoint.go();
            },
            onAddTempTaskTap: function () {
                this.$.taskForm.open();
            },
            onAddUserStorytap: function () {
                this.$.usForm.open();
            },
            noPriority: function (values) {
                if (values != null) {
                    return values.filter(function (value) {
                        return value.priority == null;
                    });
                }
            },
            withPriority: function (values) {
                if (values != null) {
                    return values.filter(function (value) {
                        return value.priority != null;
                    });
                }
            }
        });

    </script>
</polymer-element>

<polymer-element name="awall-sp2-temptask-dropzone" attributes="userstory">
    <template>
        <style>
            #dropzone {
                width: 100%;
                height: 200px;
            }
        </style>
        <div id="dropzone">
            <content></content>
        </div>
        <ads-rest-awall id="awall"></ads-rest-awall>
    </template>
    <script>
        Polymer({
            domReady: function () {
                // capture variables
                var awall = this.$.awall;
                var dropzone = this.$.dropzone;
                var userstory = this.userstory;

                // enable dropzone
                require(['core-touch'], function (touch) {
                    touch.makeDropZone(dropzone, '.taskcard', function (data) {
                        if (data.userStory != undefined) {
                            // is existing task
                            console.error('Moving a task to another user-story is not possible (backend limitation).');
                        } else {
                            // is a temporary task
                            data.userStory = userstory;
                            awall.persistTempTask(data);
                        }
                    });
                });
            }
        });
    </script>
</polymer-element>

<polymer-element name="awall-sp2-ustasks" attributes="userstoryId" noscript>
    <template>
        <template repeat="{{task in tasks}}">
            <ads-taskcard task="{{task}}"></ads-taskcard>
        </template>

        <ads-rest-tasks userStoryId="{{userstoryId}}" response="{{tasks}}" auto expand="all"></ads-rest-tasks>
    </template>
</polymer-element>

<polymer-element name="awall-sp2-us-dropzone">
    <template>
        <style>
            #container {
                height: 75px;
                width: 100%;
            }
        </style>
        <div id="container"></div>
    </template>
    <script>
        Polymer({
            domReady: function() {
                // capture variables
                var container = this.$.container;

                require(['core-touch'], function(touch) {
                    touch.makeDropZone(container, '.userstorycard', function(data) {
                        console.log('backlogged a userstory:');
                        console.dir(data);
                    });
                });
            }
        });
    </script>
</polymer-element>
